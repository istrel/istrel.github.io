<!DOCTYPE html>
<html lang="en">
<head>
  <title>Shower Presentation Engine</title>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="shower/themes/ribbon/styles/screen-16x10.css">
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/styles/docco.min.css"> -->
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/styles/color-brewer.min.css"> -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/styles/idea.min.css">
  <style>
    .slide pre code {
      line-height: 1.4;
      margin-top: -1em;
      margin-bottom: -1em;
    }
  </style>
</head>
<body class="shower list">
  <header class="caption">
    <h1>О том, как не надо тестировать</h1>
    <p>Иван Стрелков</p>
  </header>
  <section class="slide cover" id="Cover"><div>
    <h2>О том, как не надо тестировать</h2>
    <p>
      <a href="https://github.com/istrel">Иван Стрелков</a>, Avito
      <center>
        <img src="pictures/logo.svg">
      </center>
    </p>
    <!--
      To apply styles to the certain slides
      set slide ID to get needed elements
      -->
    <style>
      #Cover h2 {
        margin:30px 0 0;
        color:#000;
        text-align:center;
        font-size:70px;
        }
      #Cover p {
        margin:10px 0 0;
        text-align:center;
        color:#000;
        font-style:italic;
        font-size:20px;
        }
        #Cover p a {
          color:#000;
          }

      #Cover {
        background: white;
      }
      #Cover img {
        position: relative;
        width: 240px;
        height: 240px;
      }

      pre code {
        font-size: 21px;
      };
    </style>
  </div></section>
  <section class="slide"><div>
    <h2 class="shout">Тестирование</h2>
  </div></section>
  <section class="slide" id="pain"><div>
    <h2 class="shout">Боль</h2>
    <style>
      #pain {
        background: red;
      }

      #pain h2 {
        color: white;
      }
    </style>
  </div></section>
  <section class="slide">
    <h2>Тест</h2>
    <pre>
      <code class="javascript">
describe('VideoView', () => {
  it('is editable', () => {
    expect(<mark>new VideoView().editable</mark>).toBe(<mark>true</mark>);
  });
});
      </code>
    </pre>
  </section>
  <section class="slide">
    <h2>Код</h2>
    <pre>
      <code class="javascript">
let VideoView = GenericView.extend({
  <span class="comment">// ...</span>
  <mark>editable: true</mark>
  <span class="comment">// ...</span>
});
      </code>
    </pre>
    <span class="next">Тестируются статические данные</span>
  </section>
  <section class="slide">
    <h2>Тестирование данных - Причины</h2>
    <ol>
      <li class="next">
        "Нужно покрыть любой новый код тестами"
      </li>
      <li class="next">
        editable - флаг GenericView
      </li>
    </ol>
  </section>
  <section class="slide">
    <h2>Правильный тест</h2>
    <pre>
      <code class="javascript">
describe('GenericView', () => {
  it('disallows editing by default', () => {
    let view = new GenericView();
    expect(() => { view.edit(); }).toThrow();
  });
  it('allows editing via specifying "editable" flag', () => {
    let view = new GenericView();
    expect(() => { view.edit(); }).not.toThrow();
  });
});
      </code>
    </pre>
    <p class="note">Применим в случае если editable - документированный флаг</p>
  </section>
  <section class="slide">
    <h2>Правильный тест</h2>
    <pre>
      <code class="javascript">
describe('VideoView', () => {
  describe('editing', () => {
    it('opens editing popup', () => {
      let view = new VideoView();
      view.edit();
      expect(view.popup).not.toBe(undefined);
    });
    it('does something else', () => { /* test other stuff */ });
  });
});
      </code>
    </pre>
    <p class="note">Применим в случае если editable создан только для VideoView</p>
  </section>
  <section class="slide">
    <h2>Тестирование данных - разновидности</h2>
    <ol>
      <li>Тестирование статических текстов</li>
      <li>Тестирование статичной верстки</li>
    </ol>
  </section>
  <section class="slide">
    <h2>Тест</h2>
    <pre><code class="javascript">
describe('build step', () => {
  beforeEach(() => {
    // stub methods
    buildSystem.build('/dir1');
  });
  it('cleans directory', () => {
    expect(someLib.clean).toHaveBeenCalledWith('/dir1');
  });
  it('compiles js', () => {
    this.resolveClean();
    expect(someOtherLib.compileAll).toHaveBeenCalledWith('/dir1');
  });
});
    </code></pre>
  </section>
  <section class="slide">
    <h2>Код</h2>
    <pre><code class="javascript">
module.exports = {
  build(dir) {
    someLib.clean(dir)
      .then(() => someOtherLib.compileAll(dir));
  }
};
    </code></pre>
    <span class="next">Полное повторение структуры кода в тесте</span>
  </section>
  <section class="slide">
    <img src="pictures/test-script.jpg" alt="" class="cover">
  </section>
  <section class="slide">
    <h2>Тест-близнец</h2>
    Тест проверяет не результат, а наличие определенного кода
    <pre><code class="javascript">
describe('build step', () => {
  beforeEach(() => {
    // stub methods
    buildSystem.build('/dir1');
  });
  it('cleans directory', () => {
    expect(someLib.clean).toHaveBeenCalledWith('/dir1');
  });
  it('compiles js', () => {
    this.resolveClean();
    expect(someOtherLib.compileAll).toHaveBeenCalledWith('/dir1');
  });
});
    </code></pre>
  </section>
  <section class="slide">
    <h2>Код</h2>
    <pre><code class="html">
class HomePage extends React.Component {
  render() {
    return (
      &lt;div&gt;
        &lt;Header userName={this.props.userName} /&gt;
        &lt;Content&gt; {this.props.invitation} &lt;/Content&gt;
        &lt;Footer showSocial /&gt;
      &lt;/div&gt;
    )
  }
}
    </code></pre>
  </section>
  <section class="slide">
    <h2>Декларативный тест-близнец</h2>
    <pre><code class="javascript">
describe('HomePage', () => {
  beforeEach(() => { /* &lt;HomePage userName="vasya" invitation="hello"/&gt; */ });
  it('renders header with userName', () => {
    let header = TestUtils.findRenderedComponent(this.homePage, Header);
    expect(header.props.userName).toBe('vasya');
  });
  it('renders footer', () => {
    let footer = TestUtils.findRenderedComponent(this.homePage, Footer);
    expect(footer.props.showSocial).toBe(true);
  });
  it('renders invitation', () => {
    expect(this.container.innerHTML).toContain('hello');
  });
});
    </code></pre>
  </section>
  <section class="slide">
    <h2>Тесты-близнецы - причины</h2>
    <ol>
      <li class="next">"Тестировать изолированные модули в замоканной среде"</li>
      <li class="next">Достижение максимального coverage</li>
      <li class="next">Четкое следование методологии TDD</li>
    </ol>
  </section>
  <section class="slide">
    <h2>Код</h2>
    <pre><code class="html">
class HomePage extends React.Component {
  render() {
    return (
      &lt;div&gt;
        &lt;Header userName={this.props.userName} /&gt;
        &lt;Content children={this.props.invitation} /&gt;
        &lt;Footer showSocial /&gt;
      &lt;/div&gt;
    )
  }
}
    </code></pre>
  </section>
  <section class="slide">
    <h2>Особенности тестирования фронтенда</h2>
    <ol>
      <li class="next">Не только JS, но и HTML/CSS</li>
      <li class="next">Взаимодействие с пользователем</li>
      <li class="next">Взаимодействие с сервером</li>
      <li class="next">Асинхронность</li>
    </ol>
  </section>
  <section class="slide">
    <h2>Тест</h2>
    <ol style="margin-top: -1em">
      <li class="next">Затаскиваем шаблон для SearchViewModel в body</li>
      <li class="next">Создаем cервер моков и мокаем ответ</li>
      <li class="next">Создаем экземпляр SearchViewModel</li>
      <li class="next">Делаем ko.applyBindings()</li>
      <li class="next">Находим инпут через верстку и меняем его значение</li>
      <li class="next">Эмулируем на инпуте событие change</li>
      <li class="next">Достаем через верстку значения текстов</li>
      <li class="next">Сравниваем значения текстов с ожидаемыми</li>
      <li class="next">Останавливаем сервер моков</li>
      <li class="next">Останавливаем knockout (вернее, пытаемся его остановить)</li>
    </ol>
  </section>
  <section class="slide">
    <h2>Правильный тест</h2>
    <ol style="margin-top: -1em">
      <li class="next">Создаем экземпляр SearchViewModel, передавая ответ через параметр</li>
      <li class="next">Меняем значение поисковой строки через setter SearchViewModel</li>
      <li class="next">Достаем значения текстов через getter SearchViewModel</li>
      <li class="next">Сравниваем значения текстов с ожидаемыми</li>
    </ol>
  </section>
  <section class="slide">
    <h2>Тестирование через верстку - Page Object</h2>
    <pre><code class="javascript">
test() {
    form.toggleTube();
    form.avitoBalloon().hide();
    form.toggleAvito();
    assert(form.avitoBalloon().visible === false);
}
    </code></pre>
    <div class="next">
      В коде Page Object:
      <pre><code class="javascript">
toggleAvito() {
    this.avito().action.toggle.call(this.avito());
    basis.asap.process();
}
      </code></pre>
    </div>
  </section>
  <section class="slide">
    <h2>Слишком сложный тест - советы</h2>
    <ol>
      <li class="next">Выносите больше логики из представления в JS-модуль</li>
      <li class="next">Тестируйте через методы и свойства JS-модуля, а не через верстку/сеть</li>
      <li class="next">Перепишите тест на функциональный</li>
      <li class="next">При необходимости используйте Page Object</li>
    </ol>
  </section>
  <section class="slide">
    <h2>Асинхронный код</h2>
    <pre><code class="javascript">
class SearchForm extends React.Component {
  <mark>@Debounce(200)</mark>
  handleChange() {
    this.setState({ state: 'loading' });
    fetchResults(this.refs.query.value).then(results => {
      this.setState({ state: 'loaded', results });
    });
  }
  renderInput() {
    return &lt;input ref="query" onChange={@handleChange.bind(@)}/&gt;;
  }
  // ...
}
    </code></pre>
  </section>
  <section class="slide">
    <h2>Тест асинхронного кода</h2>
    <ol>
      <li class="next">Замокать fetchResults</li>
      <li class="next">Заменить реальный таймер поддельным</li>
      <li class="next">Изменить значение инпута</li>
      <li class="next">Сымитировать change</li>
      <li class="next">Послать поддельному таймеру сигнал о прохождении 200 мс</li>
      <li class="next">Проверить state</li>
      <li class="next">Вернуть реальный таймер на место</li>
      <li class="next">Размокать fetchResults</li>
    </ol>
  </section>
  <section class="slide">
    <h2>Отделение логики от асинхронного кода</h2>
    <pre>
      <pre><code class="javascript">
class SearchForm extends React.Component {
  renderInput() {
    return &lt;input ref="query" onChange={this.handleChange}/&gt;;
  }
  <mark>@Debounce(200) @autobind</mark>
  handleChange() {
    this.setState({ state: 'loading' });
    fetchResults(this.refs.query.value).then(results => {
      this.setState({ state: 'loaded', results });
    });
  }
  // ...
}
    </code></pre>
    </pre>
  </section>
  <section class="slide">
    <h2>Отделение логики от асинхронного кода</h2>
    <pre>
      <pre><code class="javascript">
class SearchForm extends React.Component {
  renderInput() {
    return &lt;input ref="query" onChange={this.debouncedHandleChange}/&gt;;
  }
  &nbsp;
  handleChange(<mark>value</mark>) {
    this.setState({ state: 'loading' });
    fetchResults(<mark>value</mark>).then(results => {
      this.setState({ state: 'loaded', results });
    });
  }
  <mark>@Debounce(200) @autobind
  debouncedHandleChange { this.handleChange(this.refs.query.value); }</mark>
}
    </code></pre>
    </pre>
  </section>
  <section class="slide">
    <h2>Правильный тест</h2>
    <ol>
      <li class="next">Замокать fetchResults</li>
      <li class="next">Вызвать handleChange с новым значением</li>
      <li class="next">Проверить state</li>
      <li class="next">Размокать fetchResults</li>
    </ol>
  </section>
  <section class="slide">
    <h2>Асинхронность - советы</h2>
    <ol>
      <li class="next">Отделите тестируемую логику от асинхронного взаимодействия</li>
      <li class="next">Тестируйте только когда пишите свой polling/debounce/throttling</li>
    </ol>
  </section>
  <section class="slide"><div>
    <h2 class="shout">Сухой остаток</h2>
  </div></section>
  <section class="slide"><div>
    <h2 class="shout">Оправдывает ли тест свое написание?</h2>
  </div></section>
  <section class="slide">
    <h2>Критерии оценки</h2>
    <ol>
      <li class="next">Сложность написания</li>
      <li class="next">Стоимость ошибки</li>
      <li class="next">Насколько тест покрывает функционал</li>
    </ol>
  </section>
  <section class="slide active" id="ThankYou"><div>
    <h2>Спасибо за внимание!</h2>
    <p>Иван Стрелков, Avito</p>
    <ul>
      <li><a href="https://github.com/istrel">github.com/istrel</a></li>
      <li><a href="https://twitter.com/i_strel">twitter.com/i_strel</a></li>
      <li><a href="mailto:iv-strelkov@yandex.ru">iv-strelkov@yandex.ru</a></li>
    </ul>
    <p>
      Презентация: <a href="https://istrel.github.io/">istrel.github.io</a>
    </p>
    <style>
      #ThankYou img {
        position: absolute;
        top: 200px;
        right: 100px;
        height: 300px;
      }
    </style>
  </div></section>
  <!--
    To hide progress bar from entire presentation
    just remove “progress” element.
    -->
  <div class="progress"></div>
  <script src="shower/shower.min.js"></script>
  <!-- Copyright © 2015 Yours Truly, Famous Inc. -->
  <!-- Photos by John Carey, fiftyfootshadows.net -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
